<script>
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 2 }).format(num);
    }

    function calculateRSI(closes, period = 14) {
        if (closes.length < period) return null;

        let gains = 0, losses = 0;
        for (let i = 1; i < period; i++) {
            let diff = closes[i] - closes[i - 1];
            if (diff >= 0) gains += diff;
            else losses -= diff;
        }

        let avgGain = gains / period;
        let avgLoss = losses / period;
        let rs = avgGain / avgLoss;
        return 100 - (100 / (1 + rs));
    }

    function analyzeMarket(symbol) {
        Promise.all([
            fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`).then(res => res.json()),
            fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${symbol}&limit=10`).then(res => res.json()),
            fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=5m&limit=50`).then(res => res.json())
        ]).then(([tickerData, orderBookData, klineData]) => {
            const closes = klineData.map(k => parseFloat(k[4])); // –ë–µ—Ä—ë–º —Ü–µ–Ω—ã –∑–∞–∫—Ä—ã—Ç–∏—è
            const lastPrice = parseFloat(tickerData.lastPrice);
            const changePercent = parseFloat(tickerData.priceChangePercent);
            const volume = parseFloat(tickerData.volume);
            const rsi = calculateRSI(closes);

            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ
            const maxPrice = Math.max(...closes);
            const minPrice = Math.min(...closes);
            let supportLevel = minPrice + (maxPrice - minPrice) * 0.2;
            let resistanceLevel = minPrice + (maxPrice - minPrice) * 0.8;

            // –ê–Ω–∞–ª–∏–∑ —Å—Ç–∞–∫–∞–Ω–∞ (Order Book)
            const buyVolume = orderBookData.bids.reduce((acc, bid) => acc + parseFloat(bid[1]), 0);
            const sellVolume = orderBookData.asks.reduce((acc, ask) => acc + parseFloat(ask[1]), 0);
            const orderFlow = buyVolume - sellVolume; // –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–π ‚Äì –ª–æ–Ω–≥, –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äì —à–æ—Ä—Ç

            // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π
            let signal = "‚ö™ –ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ";
            let reasons = [];

            if (lastPrice > resistanceLevel) {
                signal = "üöÄ –õ–æ–Ω–≥";
                reasons.push(`–¶–µ–Ω–∞ –ø—Ä–æ–±–∏–ª–∞ —Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ (${resistanceLevel.toFixed(2)}).`);
            } else if (lastPrice < supportLevel) {
                signal = "üìâ –®–æ—Ä—Ç";
                reasons.push(`–¶–µ–Ω–∞ —É—à–ª–∞ –Ω–∏–∂–µ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ (${supportLevel.toFixed(2)}).`);
            }

            if (changePercent > 2) {
                reasons.push(`–†–æ—Å—Ç —Ü–µ–Ω—ã ${changePercent.toFixed(2)}% –∑–∞ 24—á.`);
            } else if (changePercent < -2) {
                reasons.push(`–ü–∞–¥–µ–Ω–∏–µ —Ü–µ–Ω—ã ${changePercent.toFixed(2)}% –∑–∞ 24—á.`);
            }

            if (rsi !== null) {
                if (rsi > 55) {
                    reasons.push(`RSI = ${rsi.toFixed(2)} (–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å).`);
                } else if (rsi < 45) {
                    reasons.push(`RSI = ${rsi.toFixed(2)} (–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å).`);
                }
            }

            if (orderFlow > 0) {
                reasons.push(`–ë–æ–ª—å—à–µ —Å–ø—Ä–æ—Å–∞ –≤ —Å—Ç–∞–∫–∞–Ω–µ (–ø–æ–∫—É–ø–∞—Ç–µ–ª–∏ –∞–∫—Ç–∏–≤–Ω–µ–µ).`);
            } else {
                reasons.push(`–ë–æ–ª—å—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ —Å—Ç–∞–∫–∞–Ω–µ (–ø—Ä–æ–¥–∞–≤—Ü—ã –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç).`);
            }

            document.getElementById("crypto-stats").innerHTML = `
                <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> $${formatNumber(lastPrice)}<br>
                <strong>–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</strong>
                <span class="${changePercent >= 0 ? 'green' : 'red'}">${formatNumber(changePercent)}%</span><br>
                <strong>–û–±—ä–µ–º 24—á:</strong> ${formatNumber(volume)}
            `;

            document.getElementById("analysis").innerHTML = `
                <strong>–°–∏–≥–Ω–∞–ª:</strong> ${signal}<br>
                <ul>${reasons.map(r => `<li>${r}</li>`).join('')}</ul>
            `;
        }).catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        document.getElementById("crypto-title").textContent = `–°–∫–∞–ª—å–ø–∏–Ω–≥: ${symbol}`;
        new TradingView.widget({
            container_id: "tradingview",
            symbol: `BINANCE:${symbol}`,
            interval: "5",
            theme: "light",
            style: "1",
            locale: "ru",
            toolbar_bg: "#f1f3f6",
            enable_publishing: false,
            hide_side_toolbar: false,
            allow_symbol_change: true,
            autosize: true
        });

        analyzeMarket(symbol);
    });
</script>
