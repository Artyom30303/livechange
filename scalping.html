<script>
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 2 }).format(num);
    }

    document.addEventListener("DOMContentLoaded", function () {
        let tradingViewWidget;
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
        setTimeout(function () {
            const titleElement = document.getElementById("crypto-title");
            if (titleElement) {
                titleElement.textContent = `–°–∫–∞–ª—å–ø–∏–Ω–≥: ${symbol}`;
            } else {
                console.error("–û—à–∏–±–∫–∞: #crypto-title –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!");
            }

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
            function updatePageData(newSymbol) {
                if (titleElement) {
                    titleElement.textContent = `–°–∫–∞–ª—å–ø–∏–Ω–≥: ${newSymbol}`;
                }
                history.pushState(null, "", `?symbol=${newSymbol}`);

                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
                const tradingViewContainer = document.getElementById("tradingview");
                if (tradingViewContainer) {
                    tradingViewContainer.innerHTML = "";
                    tradingViewWidget = new TradingView.widget({
                        "container_id": "tradingview",
                        "symbol": `BINANCE:${newSymbol}`,
                        "interval": "5",
                        "theme": "light",
                        "style": "1",
                        "locale": "ru",
                        "toolbar_bg": "#f1f3f6",
                        "enable_publishing": false,
                        "hide_side_toolbar": false,
                        "allow_symbol_change": true,
                        "autosize": true
                    });
                } else {
                    console.error("–û—à–∏–±–∫–∞: #tradingview –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!");
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –º–æ–Ω–µ—Ç–µ
                fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${newSymbol}`)
                    .then(response => response.json())
                    .then(data => {
                        const cryptoStats = document.getElementById("crypto-stats");
                        if (cryptoStats) {
                            cryptoStats.innerHTML = `
                                <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> $${formatNumber(data.lastPrice)}<br>
                                <strong>–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</strong> <span class="${data.priceChangePercent >= 0 ? 'green' : 'red'}">${formatNumber(data.priceChangePercent)}%</span><br>
                                <strong>–û–±—ä–µ–º 24—á:</strong> ${formatNumber(data.volume)}
                            `;
                        }

                        const analysis = document.getElementById("analysis");
                        if (analysis) {
                            analysis.innerHTML = `–°–∏–≥–Ω–∞–ª: ${data.priceChangePercent > 2 ? 'üöÄ –õ–æ–Ω–≥' : 'üìâ –®–æ—Ä—Ç'}`;
                        }
                    });
            }

            updatePageData(symbol);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ #coin-selector
            const selector = document.getElementById("coin-selector");
            if (selector) {
                fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
                    .then(response => response.json())
                    .then(data => {
                        let coins = data.filter(c => c.symbol.endsWith("USDT"));
                        let search = document.getElementById("search");

                        function updateSelector(filter) {
                            selector.innerHTML = coins
                                .filter(c => c.symbol.includes(filter.toUpperCase()))
                                .map(c => `<option value="${c.symbol}">${c.symbol}</option>`)
                                .join("");
                        }

                        if (search) {
                            search.addEventListener("input", () => updateSelector(search.value));
                        }
                        updateSelector("");

                        selector.addEventListener("change", function () {
                            updatePageData(this.value);
                        });
                    });
            } else {
                console.error("–û—à–∏–±–∫–∞: #coin-selector –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!");
            }

            // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∞—Ç–∞
            const sendBtn = document.getElementById("send-btn");
            if (sendBtn) {
                sendBtn.addEventListener("click", function () {
                    let input = document.getElementById("chat-input").value;
                    if (input) {
                        document.getElementById("ai-chat").innerHTML += `<br>ü§ñ ${input}`;
                        document.getElementById("chat-input").value = "";
                    }
                });
            } else {
                console.error("–û—à–∏–±–∫–∞: #send-btn –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!");
            }

        }, 500);  // –ó–∞–¥–µ—Ä–∂–∫–∞ 500ms
    });
</script>
