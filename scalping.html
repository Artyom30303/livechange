<script>
    function analyzeMarket(symbol) {
        fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`)
            .then(res => res.json())
            .then(tickerData => {
                if (!tickerData || tickerData.code) {
                    console.error("–û—à–∏–±–∫–∞: –î–∞–Ω–Ω—ã–µ –ø–æ —Ç–∏–∫–µ—Ä—É –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.");
                    return;
                }

                const lastPrice = parseFloat(tickerData.lastPrice);
                const changePercent = parseFloat(tickerData.priceChangePercent);
                const volume = parseFloat(tickerData.volume);

                // –ë–µ—Ä–µ–º —Å—Ç–∞–∫–∞–Ω –∑–∞—è–≤–æ–∫
                fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${symbol}&limit=10`)
                    .then(res => res.json())
                    .then(orderBook => {
                        let bids = orderBook.bids.slice(0, 5).map(bid => parseFloat(bid[1])).reduce((a, b) => a + b, 0);
                        let asks = orderBook.asks.slice(0, 5).map(ask => parseFloat(ask[1])).reduce((a, b) => a + b, 0);

                        let direction = asks < bids ? "üöÄ –õ–æ–Ω–≥" : "üìâ –®–æ—Ä—Ç";
                        let entry = lastPrice;
                        let stopLoss = direction === "üöÄ –õ–æ–Ω–≥" ? entry * 0.98 : entry * 1.02;
                        let takeProfit1 = direction === "üöÄ –õ–æ–Ω–≥" ? entry * 1.02 : entry * 0.98;
                        let takeProfit2 = direction === "üöÄ –õ–æ–Ω–≥" ? entry * 1.04 : entry * 0.96;
                        let takeProfit3 = direction === "üöÄ –õ–æ–Ω–≥" ? entry * 1.06 : entry * 0.94;

                        let reasoning = [
                            asks < bids ? "üü¢ –í —Å—Ç–∞–∫–∞–Ω–µ –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏, —Ü–µ–Ω–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ –ø–æ–π–¥–µ—Ç –≤–≤–µ—Ä—Ö." : "üî¥ –í —Å—Ç–∞–∫–∞–Ω–µ –±–æ–ª—å—à–µ –ø—Ä–æ–¥–∞–∂, –±—ã—á–∫–æ–≤ –µ–±—É—Ç –Ω–∞ –ø–æ–Ω–∏–∂–µ–Ω–∏–µ.",
                            changePercent > 2 ? "‚ö° –¶–µ–Ω–∞ —É–∂–µ –∏–¥–µ—Ç –≤ –∏–º–ø—É–ª—å—Å–µ, –æ—Å—Ç–æ—Ä–æ–∂–Ω–µ–µ —Å –≤—Ö–æ–¥–æ–º." : "üìâ –¶–µ–Ω–∞ –ø–æ–∫–∞ –≤ –∑–æ–Ω–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –º–æ–∂–Ω–æ –∑–∞–ª–µ—Ç–∞—Ç—å.",
                            stopLoss < lastPrice ? "üõë –°—Ç–æ–ø –ª–æ—Å—Å –ø–æ—Å—Ç–∞–≤–ª–µ–Ω —Å –∑–∞–ø–∞—Å–æ–º, —á—Ç–æ–±—ã –Ω–µ –≤—ã–±–∏–ª–æ —Ñ–µ–π–∫–æ–≤—ã–º–∏ —Å–≤–µ—á–∞–º–∏." : "üìâ –õ—É—á—à–µ –¥–≤–∏–Ω—É—Ç—å —Å—Ç–æ–ø –ø–æ–±–ª–∏–∂–µ, –º–æ–∂–µ—Ç –≤—ã–±–∏—Ç—å."
                        ];

                        let signalBox = `
                            <div class="signal-box ${direction === "üöÄ –õ–æ–Ω–≥" ? "long" : "short"}">
                                <strong>–°–∏–≥–Ω–∞–ª:</strong> ${direction}<br>
                                <ul>
                                    <li>üìç –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: <strong>$${entry.toFixed(2)}</strong></li>
                                    <li>üõë –°—Ç–æ–ø-–ª–æ—Å—Å: <strong>$${stopLoss.toFixed(2)}</strong></li>
                                    <li>üéØ –¢–µ–π–∫ 1: <strong>$${takeProfit1.toFixed(2)}</strong></li>
                                    <li>üéØ –¢–µ–π–∫ 2: <strong>$${takeProfit2.toFixed(2)}</strong></li>
                                    <li>üéØ –¢–µ–π–∫ 3: <strong>$${takeProfit3.toFixed(2)}</strong></li>
                                </ul>
                                <strong>üß† –ê—Ä–≥—É–º–µ–Ω—Ç—ã:</strong>
                                <ul><li>${reasoning.join("</li><li>")}</li></ul>
                            </div>
                        `;

                        document.getElementById("analysis-content").innerHTML = signalBox;

                        document.getElementById("crypto-stats").innerHTML = `
                            <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> $${lastPrice.toFixed(2)}<br>
                            <strong>–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</strong> <span class="${changePercent >= 0 ? 'green' : 'red'}">${changePercent.toFixed(2)}%</span><br>
                            <strong>–û–±—ä–µ–º 24—á:</strong> ${volume.toFixed(2)}
                        `;

                        logTrade(symbol, entry, changePercent);
                    });
            }).catch(err => console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:", err));
    }

    function logTrade(symbol, price, change) {
        let logEntry = `<p><strong>${symbol}</strong> - –¶–µ–Ω–∞: $${price.toFixed(2)} (–ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${change.toFixed(2)}%)</p>`;
        document.getElementById("trader-journal").innerHTML += logEntry;
    }

    function initTradingView(symbol) {
        setTimeout(() => {
            new TradingView.widget({
                container_id: "tradingview",
                symbol: `BINANCE:${symbol}`,
                interval: "30",
                theme: "light",
                style: "1",
                locale: "ru",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_side_toolbar: false,
                allow_symbol_change: true,
                autosize: true
            });
        }, 1000);
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        document.getElementById("crypto-title").textContent = `–°–∫–∞–ª—å–ø–∏–Ω–≥: ${symbol}`;

        initTradingView(symbol);
        analyzeMarket(symbol);
        fetchCoins();
    });
</script>
