<script>
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 2 }).format(num);
    }

    document.addEventListener("DOMContentLoaded", function () {
        let tradingViewWidget;
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        function updatePageData(newSymbol) {
            const titleElement = document.getElementById("crypto-title");

            if (!titleElement) {
                console.error("–û—à–∏–±–∫–∞: –≠–ª–µ–º–µ–Ω—Ç #crypto-title –Ω–µ –Ω–∞–π–¥–µ–Ω!");
                return;
            }

            titleElement.textContent = `–°–∫–∞–ª—å–ø–∏–Ω–≥: ${newSymbol}`;
            history.pushState(null, "", `?symbol=${newSymbol}`);

            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–π –≥—Ä–∞—Ñ–∏–∫ –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            document.getElementById("tradingview").innerHTML = "";
            tradingViewWidget = new TradingView.widget({
                "container_id": "tradingview",
                "symbol": `BINANCE:${newSymbol}`,
                "interval": "5",
                "theme": "light",
                "style": "1",
                "locale": "ru",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "autosize": true
            });

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ –º–æ–Ω–µ—Ç–µ
            fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${newSymbol}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById("crypto-stats").innerHTML = `
                        <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> $${formatNumber(data.lastPrice)}<br>
                        <strong>–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</strong> <span class="${data.priceChangePercent >= 0 ? 'green' : 'red'}">${formatNumber(data.priceChangePercent)}%</span><br>
                        <strong>–û–±—ä–µ–º 24—á:</strong> ${formatNumber(data.volume)}
                    `;
                    document.getElementById("analysis").innerHTML = `–°–∏–≥–Ω–∞–ª: ${data.priceChangePercent > 2 ? 'üöÄ –õ–æ–Ω–≥' : 'üìâ –®–æ—Ä—Ç'}`;
                });
        }

        if (document.getElementById("crypto-title")) {
            updatePageData(symbol);
        } else {
            console.error("–û—à–∏–±–∫–∞: #crypto-title –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM!");
        }

        fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
            .then(response => response.json())
            .then(data => {
                let coins = data.filter(c => c.symbol.endsWith("USDT"));
                let selector = document.getElementById("coin-selector");
                let search = document.getElementById("search");

                function updateSelector(filter) {
                    selector.innerHTML = coins
                        .filter(c => c.symbol.includes(filter.toUpperCase()))
                        .map(c => `<option value="${c.symbol}">${c.symbol}</option>`)
                        .join("");
                }

                search.addEventListener("input", () => updateSelector(search.value));
                updateSelector("");

                selector.addEventListener("change", function () {
                    updatePageData(this.value);
                });
            });

        // –ù–∞–≤–µ—à–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞ –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–∞—Ç–∞
        document.getElementById("send-btn").addEventListener("click", function () {
            let input = document.getElementById("chat-input").value;
            if (input) {
                document.getElementById("ai-chat").innerHTML += `<br>ü§ñ ${input}`;
                document.getElementById("chat-input").value = "";
            }
        });
    });
</script>
