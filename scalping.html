<script>
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 2 }).format(num);
    }

    function waitForElement(selector, callback, timeout = 5000) {
        const startTime = Date.now();
        function check() {
            const element = document.querySelector(selector);
            if (element) {
                callback(element);
            } else if (Date.now() - startTime < timeout) {
                setTimeout(check, 100);
            } else {
                console.error(`Ошибка: ${selector} не найден в DOM через ${timeout}мс!`);
            }
        }
        check();
    }

    function waitForTradingView(callback) {
        const startTime = Date.now();
        function check() {
            if (typeof TradingView !== "undefined") {
                callback();
            } else if (Date.now() - startTime < 5000) {
                setTimeout(check, 100);
            } else {
                console.error("Ошибка: TradingView API не загрузился.");
            }
        }
        check();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        // Ждём элемент #crypto-title перед изменением
        waitForElement("#crypto-title", (titleElement) => {
            titleElement.textContent = `Скальпинг: ${symbol}`;
        });

        // Ждём загрузки TradingView перед созданием виджета
        waitForTradingView(() => {
            new TradingView.widget({
                container_id: "tradingview",
                symbol: `BINANCE:${symbol}`,
                interval: "5",
                theme: "light",
                style: "1",
                locale: "ru",
                toolbar_bg: "#f1f3f6",
                enable_publishing: false,
                hide_side_toolbar: false,
                allow_symbol_change: true,
                autosize: true
            });
        });

        fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`)
            .then(res => res.json())
            .then(data => {
                waitForElement("#crypto-stats", (cryptoStats) => {
                    cryptoStats.innerHTML = `
                        <strong>Текущая цена:</strong> $${formatNumber(data.lastPrice)}<br>
                        <strong>Изменение 24ч:</strong>
                        <span class="${data.priceChangePercent >= 0 ? 'green' : 'red'}">
                            ${formatNumber(data.priceChangePercent)}%
                        </span><br>
                        <strong>Объем 24ч:</strong> ${formatNumber(data.volume)}
                    `;
                });
            }).catch(err => console.error("Ошибка загрузки данных:", err));
    });
</script>
