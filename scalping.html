<script>
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 2 }).format(num);
    }

    function analyzeMarket(symbol) {
        Promise.all([
            fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`).then(res => res.json()),
            fetch(`https://fapi.binance.com/fapi/v1/depth?symbol=${symbol}&limit=10`).then(res => res.json()),
            fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=5m&limit=50`).then(res => res.json())
        ]).then(([tickerData, orderBookData, klineData]) => {
            if (!tickerData || !orderBookData || !klineData) {
                console.error("Ошибка: Данные не загружены.");
                return;
            }

            const lastPrice = parseFloat(tickerData.lastPrice);
            const changePercent = parseFloat(tickerData.priceChangePercent);
            const volume = parseFloat(tickerData.volume);

            // Проверяем, существует ли элемент перед изменением
            const titleElement = document.getElementById("crypto-title");
            if (titleElement) {
                titleElement.textContent = `Скальпинг: ${symbol}`;
            } else {
                console.error("Ошибка: #crypto-title не найден в DOM!");
            }

            const statsElement = document.getElementById("crypto-stats");
            if (statsElement) {
                statsElement.innerHTML = `
                    <strong>Текущая цена:</strong> $${formatNumber(lastPrice)}<br>
                    <strong>Изменение 24ч:</strong>
                    <span class="${changePercent >= 0 ? 'green' : 'red'}">${formatNumber(changePercent)}%</span><br>
                    <strong>Объем 24ч:</strong> ${formatNumber(volume)}
                `;
            } else {
                console.error("Ошибка: #crypto-stats не найден в DOM!");
            }
        }).catch(err => console.error("Ошибка загрузки данных:", err));
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        // Проверяем перед установкой текста
        const titleElement = document.getElementById("crypto-title");
        if (titleElement) {
            titleElement.textContent = `Скальпинг: ${symbol}`;
        } else {
            console.error("Ошибка: #crypto-title не найден в DOM!");
        }

        new TradingView.widget({
            container_id: "tradingview",
            symbol: `BINANCE:${symbol}`,
            interval: "5",
            theme: "light",
            style: "1",
            locale: "ru",
            toolbar_bg: "#f1f3f6",
            enable_publishing: false,
            hide_side_toolbar: false,
            allow_symbol_change: true,
            autosize: true
        });

        analyzeMarket(symbol);
    });
</script>
