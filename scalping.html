<script>
    function formatNumber(num) {
        return new Intl.NumberFormat('ru-RU', { maximumFractionDigits: 2 }).format(num);
    }

    function waitForElement(selector, callback, timeout = 5000) {
        const startTime = Date.now();
        function check() {
            const element = document.querySelector(selector);
            if (element) {
                callback(element);
            } else if (Date.now() - startTime < timeout) {
                setTimeout(check, 100);
            } else {
                console.error(`–û—à–∏–±–∫–∞: ${selector} –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ DOM —á–µ—Ä–µ–∑ ${timeout}–º—Å!`);
            }
        }
        check();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const urlParams = new URLSearchParams(window.location.search);
        let symbol = urlParams.get("symbol") || "BTCUSDT";

        waitForElement("#crypto-title", (titleElement) => {
            titleElement.textContent = `–°–∫–∞–ª—å–ø–∏–Ω–≥: ${symbol}`;
        });

        waitForElement("#tradingview", (tradingViewContainer) => {
            tradingViewContainer.innerHTML = "";
            new TradingView.widget({
                "container_id": "tradingview",
                "symbol": `BINANCE:${symbol}`,
                "interval": "5",
                "theme": "light",
                "style": "1",
                "locale": "ru",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "allow_symbol_change": true,
                "autosize": true
            });
        });

        fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbol=${symbol}`)
            .then(response => response.json())
            .then(data => {
                waitForElement("#crypto-stats", (cryptoStats) => {
                    cryptoStats.innerHTML = `
                        <strong>–¢–µ–∫—É—â–∞—è —Ü–µ–Ω–∞:</strong> $${formatNumber(data.lastPrice)}<br>
                        <strong>–ò–∑–º–µ–Ω–µ–Ω–∏–µ 24—á:</strong> <span class="${data.priceChangePercent >= 0 ? 'green' : 'red'}">${formatNumber(data.priceChangePercent)}%</span><br>
                        <strong>–û–±—ä–µ–º 24—á:</strong> ${formatNumber(data.volume)}
                    `;
                });

                waitForElement("#analysis", (analysis) => {
                    analysis.innerHTML = `–°–∏–≥–Ω–∞–ª: ${data.priceChangePercent > 2 ? 'üöÄ –õ–æ–Ω–≥' : 'üìâ –®–æ—Ä—Ç'}`;
                });
            });

        waitForElement("#coin-selector", (selector) => {
            fetch("https://fapi.binance.com/fapi/v1/ticker/24hr")
                .then(response => response.json())
                .then(data => {
                    let coins = data.filter(c => c.symbol.endsWith("USDT"));
                    let search = document.getElementById("search");

                    function updateSelector(filter) {
                        selector.innerHTML = coins
                            .filter(c => c.symbol.includes(filter.toUpperCase()))
                            .map(c => `<option value="${c.symbol}">${c.symbol}</option>`)
                            .join("");
                    }

                    if (search) {
                        search.addEventListener("input", () => updateSelector(search.value));
                    }
                    updateSelector("");

                    selector.addEventListener("change", function () {
                        history.pushState(null, "", `?symbol=${this.value}`);
                        location.reload(); // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–≥—Ä—É–∂–∞–µ–º, –µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –µ—Å—Ç—å –±–∞–≥–∏
                    });
                });
        });

        waitForElement("#send-btn", (sendBtn) => {
            sendBtn.addEventListener("click", function () {
                let input = document.getElementById("chat-input").value;
                if (input) {
                    document.getElementById("ai-chat").innerHTML += `<br>ü§ñ ${input}`;
                    document.getElementById("chat-input").value = "";
                }
            });
        });
    });
</script>
